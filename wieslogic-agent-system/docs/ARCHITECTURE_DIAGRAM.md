# WiesLogic Agent System - Architecture Diagram

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         WIES.AI Platform                                │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                    WIES.AI Backend (NestJS)                       │ │
│  │  ┌─────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │ │
│  │  │   Customer      │  │   WiesLogic      │  │   Analytics     │ │ │
│  │  │   Management    │  │   Configuration  │  │   Dashboard     │ │ │
│  │  └────────┬────────┘  └────────┬─────────┘  └─────────────────┘ │ │
│  └───────────┼─────────────────────┼────────────────────────────────┘ │
└──────────────┼─────────────────────┼──────────────────────────────────┘
               │                     │
               │ REST API            │ Configuration
               │                     │
               ▼                     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         n8n Workflow Platform                           │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                  AI_WIESLOGIC_MASTER (Orchestrator)               │ │
│  │                                                                   │ │
│  │  [Webhook] → [Validate] → [Load Config] → [Route] → [Monitor]  │ │
│  │       ↓                                       ↓                   │ │
│  │  [Error Handler] ← ← ← ← ← ← ← ← ← ← ← [Fallback]              │ │
│  └───┬───────────────┬──────────────┬───────────────┬──────────────┘ │
│      │               │              │               │                  │
│      ▼               ▼              ▼               ▼                  │
│  ┌────────┐    ┌──────────┐   ┌─────────┐    ┌──────────┐           │
│  │ Lead   │    │Technical │   │  Sales  │    │ Service  │           │
│  │ Agent  │───▶│  Agent   │──▶│  Agent  │───▶│  Agent   │           │
│  └────┬───┘    └────┬─────┘   └────┬────┘    └────┬─────┘           │
└───────┼─────────────┼──────────────┼──────────────┼──────────────────┘
        │             │              │              │
        │             │              │              │
        ▼             ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         Data Layer                                      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │               Google Sheets (Robopac_Database)                  │  │
│  │                                                                 │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │  │
│  │  │ 01_Inquiries │  │ 02_Quotations│  │ 03_Customer  │        │  │
│  │  │     _Log     │  │   _Options   │  │   _Profile   │        │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │  │
│  │                                                                 │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │  │
│  │  │ 06_Product_  │  │ 07_Mechanical│  │ 08_Electrical│        │  │
│  │  │  Portfolio   │  │    _Specs    │  │    _Specs    │        │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │  │
│  │                                                                 │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │  │
│  │  │ 13_Master_   │  │ 15_System_   │  │ 16_Evaluation│        │  │
│  │  │     Log      │  │  Health_Log  │  │     _Log     │        │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘        │  │
│  └─────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         AI Services                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                 │
│  │   OpenAI     │  │     RAG      │  │  Hunter.io   │                 │
│  │   GPT-4      │  │ Vector Store │  │  Enrichment  │                 │
│  └──────────────┘  └──────────────┘  └──────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
```

## Multi-Customer Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      Master Controller Routing                           │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
        ┌─────────────────┐ ┌─────────────┐ ┌─────────────┐
        │   Customer A    │ │ Customer B  │ │ Customer C  │
        │ (Robopac/AETNA) │ │             │ │             │
        └────────┬────────┘ └──────┬──────┘ └──────┬──────┘
                 │                 │               │
                 ▼                 ▼               ▼
        ┌──────────────┐  ┌──────────────┐ ┌──────────────┐
        │ Config:      │  │ Config:      │ │ Config:      │
        │ • All Agents │  │ • Lead Only  │ │ • Lead+Sales │
        │ • 10 Products│  │ • 3 Products │ │ • 5 Products │
        │ • Full RAG   │  │ • Basic RAG  │ │ • No RAG     │
        └──────┬───────┘  └──────┬───────┘ └──────┬───────┘
               │                 │                 │
               ▼                 ▼                 ▼
        ┌──────────────┐  ┌──────────────┐ ┌──────────────┐
        │ Google Sheet │  │ Google Sheet │ │ Google Sheet │
        │  (Dedicated) │  │  (Dedicated) │ │  (Dedicated) │
        └──────────────┘  └──────────────┘ └──────────────┘
```

## Agent Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Lead Agent Workflow                            │
└─────────────────────────────────────────────────────────────────────────┘

[Web Form] ──────────────────────────┐
[Email] ─────────────────────────────┤
[API] ───────────────────────────────┤
                                     │
                                     ▼
                          ┌──────────────────┐
                          │  Lead Webhook    │
                          │  Entry Point     │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │  Validate Input  │
                          │  (BANT Check)    │
                          └────────┬─────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    │ Valid?       │              │
                    ▼              ▼              ▼
              ┌──────────┐  ┌──────────┐   ┌──────────┐
              │ Enrich   │  │  Score   │   │  Log to  │
              │ Data     │  │  Lead    │   │  Sheet   │
              │(Hunter)  │  │          │   │          │
              └────┬─────┘  └────┬─────┘   └────┬─────┘
                   │             │              │
                   └─────────────┼──────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ Score >= Thresh?│
                        └────────┬────────┘
                                 │
                  ┌──────────────┼──────────────┐
                  │ Yes          │              │ No
                  ▼              │              ▼
        ┌──────────────────┐    │    ┌──────────────────┐
        │ Handover to      │    │    │ Lead Nurture     │
        │ Technical Agent  │    │    │ Campaign         │
        └──────────────────┘    │    └──────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Update Master   │
                       │ Log & Notify    │
                       └─────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                       Technical Agent Workflow                          │
└─────────────────────────────────────────────────────────────────────────┘

[Lead Agent Handover] ────────────────┐
                                      │
                                      ▼
                          ┌──────────────────┐
                          │ Technical        │
                          │ Webhook Entry    │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ Load Product     │
                          │ Specifications   │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ Product          │
                          │ Calculator       │◀───── (product-calculators.js)
                          └────────┬─────────┘
                                   │
                     ┌─────────────┼─────────────┐
                     │             │             │
                     ▼             ▼             ▼
             ┌──────────┐  ┌──────────┐  ┌──────────┐
             │Mechanical│  │Electrical│  │Packaging │
             │  Check   │  │  Check   │  │  Check   │
             └────┬─────┘  └────┬─────┘  └────┬─────┘
                  │             │             │
                  └─────────────┼─────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ RAG Analysis    │
                       │ (Vector Search) │
                       └────────┬────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Generate        │
                       │ Recommendation  │
                       └────────┬────────┘
                                │
                  ┌─────────────┼─────────────┐
                  │ Feasible?   │             │
                  ▼             │             ▼
        ┌──────────────┐       │      ┌──────────────┐
        │ Handover to  │       │      │ Not Feasible │
        │ Sales Agent  │       │      │ Notification │
        └──────────────┘       │      └──────────────┘
                               │
                               ▼
                      ┌─────────────────┐
                      │ Log Evaluation  │
                      │ & Update Master │
                      └─────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         Sales Agent Workflow                            │
└─────────────────────────────────────────────────────────────────────────┘

[Technical Agent Handover] ───────────┐
                                      │
                                      ▼
                          ┌──────────────────┐
                          │ Sales Webhook    │
                          │ Entry Point      │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ Load Pricing     │
                          │ Matrix           │
                          └────────┬─────────┘
                                   │
                                   ▼
                          ┌──────────────────┐
                          │ Opportunity      │
                          │ Scoring          │
                          └────────┬─────────┘
                                   │
                     ┌─────────────┼─────────────┐
                     │             │             │
                     ▼             ▼             ▼
             ┌──────────┐  ┌──────────┐  ┌──────────┐
             │ Base     │  │ Volume   │  │Strategic │
             │ Pricing  │  │ Discount │  │ Value    │
             └────┬─────┘  └────┬─────┘  └────┬─────┘
                  │             │             │
                  └─────────────┼─────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Generate        │
                       │ Quotation(s)    │
                       └────────┬────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Approval        │
                       │ Required?       │
                       └────────┬────────┘
                                │
                  ┌─────────────┼─────────────┐
                  │ Yes         │             │ No
                  ▼             │             ▼
        ┌──────────────┐       │      ┌──────────────┐
        │ Send for     │       │      │ Auto-approve │
        │ Approval     │       │      │ & Send Email │
        └──────────────┘       │      └──────────────┘
                               │
                               ▼
                      ┌─────────────────┐
                      │ Update Sheets   │
                      │ & Send Report   │
                      └─────────────────┘
```

## Product Calculator Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Calculator Factory Pattern                         │
└─────────────────────────────────────────────────────────────────────────┘

[Technical Agent] ──────────────────────┐
                                        │
                                        ▼
                           ┌──────────────────────┐
                           │  CalculatorFactory   │
                           │  .getCalculator()    │
                           └──────────┬───────────┘
                                      │
                ┌─────────────────────┼─────────────────────┐
                │                     │                     │
                ▼                     ▼                     ▼
      ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
      │ PalletWrapper   │   │  Palletizer     │   │  Depalletizer   │
      │   Calculator    │   │   Calculator    │   │   Calculator    │
      └────────┬────────┘   └────────┬────────┘   └────────┬────────┘
               │                     │                     │
               ▼                     ▼                     ▼
      ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
      │     LGV         │   │  CasePacker     │   │ ShrinkWrapper   │
      │   Calculator    │   │   Calculator    │   │   Calculator    │
      └────────┬────────┘   └────────┬────────┘   └────────┬────────┘
               │                     │                     │
               ▼                     ▼                     ▼
      ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
      │  BagSealer      │   │  CasePacking    │   │     Cobot       │
      │   Calculator    │   │   Calculator    │   │   Calculator    │
      └─────────────────┘   └─────────────────┘   └─────────────────┘

Each Calculator Provides:
┌──────────────────────────────────────────────────────────────────────┐
│ • calculate(inputs) → results                                        │
│ • Throughput analysis                                                │
│ • Efficiency calculations                                            │
│ • Model recommendations                                              │
│ • Cost estimates                                                     │
│ • Meets requirement validation                                       │
└──────────────────────────────────────────────────────────────────────┘
```

## Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Error Handling System                          │
└─────────────────────────────────────────────────────────────────────────┘

[Any Agent Error] ───────────────────┐
                                     │
                                     ▼
                         ┌──────────────────┐
                         │  Error Handler   │
                         │  (Catch Block)   │
                         └────────┬─────────┘
                                  │
                                  ▼
                         ┌──────────────────┐
                         │ Classify Error   │
                         │ & Severity       │
                         └────────┬─────────┘
                                  │
         ┌────────────────────────┼────────────────────────┐
         │                        │                        │
         ▼                        ▼                        ▼
   ┌──────────┐            ┌──────────┐            ┌──────────┐
   │CRITICAL  │            │   HIGH   │            │ MEDIUM   │
   │          │            │          │            │          │
   └────┬─────┘            └────┬─────┘            └────┬─────┘
        │                       │                       │
        ▼                       ▼                       ▼
   ┌──────────┐            ┌──────────┐            ┌──────────┐
   │ Notify   │            │  Retry   │            │   Log    │
   │ Admin    │            │ 3 times  │            │ Continue │
   └────┬─────┘            └────┬─────┘            └────┬─────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Log to Health   │
                       │ Log & Master    │
                       └────────┬────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │ Recovery Action │
                       │ or Escalation   │
                       └─────────────────┘
```

## Data Flow Sequence

```
Step 1: Lead Enters System
┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐
│Web   │───▶│Lead  │───▶│Sheet │───▶│Master│
│Form  │    │Agent │    │Write │    │Log   │
└──────┘    └──────┘    └──────┘    └──────┘

Step 2: Lead Qualification
┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐
│BANT  │───▶│Score │───▶│Enrich│───▶│Intel │
│Check │    │Calc  │    │Data  │    │Log   │
└──────┘    └──────┘    └──────┘    └──────┘

Step 3: Technical Analysis
┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐
│Tech  │───▶│Calc  │───▶│RAG   │───▶│Eval  │
│Agent │    │Module│    │Query │    │Log   │
└──────┘    └──────┘    └──────┘    └──────┘

Step 4: Sales Processing
┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐
│Sales │───▶│Price │───▶│Quote │───▶│Email │
│Agent │    │Calc  │    │Gen   │    │Send  │
└──────┘    └──────┘    └──────┘    └──────┘

Step 5: Logging & Analytics
┌──────┐    ┌──────┐    ┌──────┐    ┌──────┐
│All   │───▶│Master│───▶│Health│───▶│Dash  │
│Agents│    │Log   │    │Check │    │board │
└──────┘    └──────┘    └──────┘    └──────┘
```

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Production Environment                          │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────────┐         ┌──────────────────────┐
│   Vercel (Frontend)  │         │   Render (Backend)   │
│                      │         │                      │
│  • WIES.AI Landing   │◀───────▶│  • NestJS API        │
│  • Customer Dashboard│         │  • Prisma ORM        │
│  • Admin Interface   │         │  • PostgreSQL        │
└──────────┬───────────┘         └──────────┬───────────┘
           │                                │
           │                                │
           ▼                                ▼
┌──────────────────────────────────────────────────────┐
│              n8n Cloud / Self-Hosted                 │
│                                                      │
│  • Master Controller                                 │
│  • Lead Agent                                        │
│  • Technical Agent                                   │
│  • Sales Agent                                       │
└──────────┬───────────────────────────────────────────┘
           │
           ▼
┌──────────────────────┐         ┌──────────────────────┐
│  Google Workspace    │         │    OpenAI API        │
│                      │         │                      │
│  • Google Sheets     │         │  • GPT-4 Turbo       │
│  • Google Docs       │         │  • Vector Stores     │
│  • Gmail (Send)      │         │  • Embeddings        │
└──────────────────────┘         └──────────────────────┘
```

---

**Legend:**
- `───▶` : Data flow
- `◀───▶` : Bidirectional communication
- `└─┘` : Sequential process
- `[Node]` : System component
- `┌─┐` : Container/boundary
